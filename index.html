<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>È≠îÊ≥ï„ÅÆÁ≠ÜÁÆóÈÅìÂ†¥</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Mochiy+Pop+P+One&display=swap');

:root{
  --primary:#4CAF50;
  --secondary:#FFC107;
  --accent:#2196F3;
  --bg:#f0f4f8;
  --font:'Mochiy Pop P One','Hiragino Maru Gothic ProN','Rounded Mplus 1c',sans-serif;
}

body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:var(--bg);
  font-family:var(--font);
}

.container{
  position:relative;
  background:#fff;
  border-radius:20px;
  padding:25px;
  width:95%;
  max-width:500px;
  border:5px solid var(--primary);
  text-align:center;
}

.stats-area{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.total-gems{font-size:20px;color:#fbc02d;}
.title-display{
  background:#fff9f0;
  border-radius:20px;
  padding:4px 15px;
  color:#e91e63;
}

.level-select{margin:10px 0;}
.level-btn{
  border:none;
  padding:8px 12px;
  border-radius:12px;
  font-family:var(--font);
}
.level-btn.active{background:var(--secondary);}

.board{
  display:grid;
  grid-template-columns:repeat(5,50px);
  gap:2px;
  padding:15px;
  border-radius:15px;
  border:3px solid #ddd;
  margin:10px auto;
}

.cell{
  width:50px;height:50px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:28px;
  border-radius:6px;
}

.cell.input{background:#e3f2fd;border:2px dashed var(--accent);}
.cell.active{border:3px solid #ff5722;}
.cell.op{color:#999;}
.line{grid-column:1/6;height:4px;background:#444;}

.cell.highlight{
  background:#fff59d;
  animation:pulse 0.6s alternate infinite;
}
@keyframes pulse{
  from{box-shadow:0 0 5px gold;}
  to{box-shadow:0 0 15px gold;}
}

.keyboard{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}

.key{
  padding:15px;
  font-size:22px;
  border:none;
  border-radius:12px;
  background:var(--accent);
  color:#fff;
  font-family:var(--font);
}
.key.del{background:#f44336;}
.key.enter{grid-column:span 3;background:var(--primary);}

#combo{
  height:28px;
  color:#ff5722;
  font-size:20px;
}

.hint-btn{
  margin-bottom:6px;
  background:#ff9800;
  color:#fff;
  border:none;
  padding:6px 14px;
  border-radius:20px;
  font-family:var(--font);
}

.overlay{
  position:absolute;
  inset:0;
  background:rgba(255,255,255,0.95);
  display:none;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  border-radius:20px;
}

.confetti{
  position:absolute;
  font-size:24px;
  animation:fall 1.5s linear forwards;
}
@keyframes fall{
  to{transform:translateY(300px) rotate(360deg);opacity:0;}
}
</style>
</head>

<body>
<div class="container">

<div class="stats-area">
  <div class="total-gems">üíé <span id="totalGemsCount">0</span></div>
  <div class="title-display">Áß∞Âè∑: <span id="currentTitle">„Åã„Åë„Å†„Åó</span></div>
</div>

<div class="level-select">
  <button class="level-btn active" onclick="setLevel(1)">Ë¶ãÁøí„ÅÑ</button>
  <button class="level-btn" onclick="setLevel(2)">È≠îÂ∞éÂ∏´</button>
  <button class="level-btn" onclick="setLevel(3)">Â§ßË≥¢ËÄÖ</button>
</div>

<button class="hint-btn" onclick="showHint()">„Éí„É≥„Éà‚ú®</button>
<div id="combo"></div>

<div class="board" id="board"></div>

<div class="keyboard">
  <button class="key" onclick="inputNum(1)">1</button>
  <button class="key" onclick="inputNum(2)">2</button>
  <button class="key" onclick="inputNum(3)">3</button>
  <button class="key" onclick="inputNum(4)">4</button>
  <button class="key" onclick="inputNum(5)">5</button>
  <button class="key" onclick="inputNum(6)">6</button>
  <button class="key" onclick="inputNum(7)">7</button>
  <button class="key" onclick="inputNum(8)">8</button>
  <button class="key" onclick="inputNum(9)">9</button>
  <button class="key del" onclick="inputNum('del')">‚Ü©</button>
  <button class="key" onclick="inputNum(0)">0</button>
  <button class="key enter" onclick="check()">OK!</button>
</div>

<div class="overlay" id="clearOverlay">
  <h2 style="font-size:40px;">ÂêàÊ†ºÔºÅ</h2>
  <div id="gems" style="font-size:60px;"></div>
  <button class="key" onclick="initGame()">„Å§„Å•„Åë„Çã</button>
</div>

</div>

<script>
const titles=["„Åã„Åë„Å†„Åó","Ë¶ãÁøí„ÅÑÈ≠îÊ≥ï‰Ωø„ÅÑ","È≠îÊ≥ï„ÅÆÁ≠Ü‰Ωø„ÅÑ","Â§ßÈ≠îÂ∞éÂ∏´","Á≠ÜÁÆó„ÅÆÁ•û"];
let level=1,n1,n2,steps=[],cur=0,combo=0;
let totalGems=+localStorage.getItem("mathGems")||0;
let soundOK=false;

const magic=new Audio("https://actions.google.com/sounds/v1/cartoon/glissando.ogg");
const clearSound=new Audio("https://actions.google.com/sounds/v1/cartoon/positive_musical_chip.ogg");

function updateStats(){
  totalGemsCount.textContent=totalGems;
  currentTitle.textContent=titles[Math.min(Math.floor(totalGems/10),titles.length-1)];
}

function setLevel(l){
  level=l;
  document.querySelectorAll(".level-btn").forEach((b,i)=>b.classList.toggle("active",i+1===l));
  initGame();
}

function initGame(){
  clearOverlay.style.display="none";
  combo=0; combo.textContent="";
  updateStats();

  if(level===1){
    do{
      n1=Math.floor(Math.random()*80)+12;
      n2=Math.floor(Math.random()*5)+11;
    }while((n1%10)*(n2%10)>=10);
  }else{
    n1=Math.floor(Math.random()*80)+12;
    n2=Math.floor(Math.random()*80)+12;
  }

  const p1=n1*(n2%10);
  const p2=n1*Math.floor(n2/10);
  const t=n1*n2;

  steps=[
    {id:"p1",a:p1%10},{id:"p2",a:Math.floor(p1/10)%10},
    {id:"p3",a:p2%10},{id:"p4",a:Math.floor(p2/10)%10},
    {id:"a1",a:t%10},{id:"a2",a:Math.floor(t/10)%10}
  ];

  board.innerHTML=`
  <div></div><div>${Math.floor(n1/10)}</div><div>${n1%10}</div>
  <div>√ó</div><div>${Math.floor(n2/10)}</div><div>${n2%10}</div>
  <div class="line"></div>
  <div id="p2" class="cell input"></div><div id="p1" class="cell input"></div>
  <div class="line"></div>
  <div id="a2" class="cell input"></div><div id="a1" class="cell input"></div>
  `;
  cur=0; highlight();
}

function highlight(){
  document.querySelectorAll(".cell").forEach(c=>c.classList.remove("active","highlight"));
  const c=document.getElementById(steps[cur].id);
  if(c)c.classList.add("active","highlight");
}

function showHint(){
  const c=document.getElementById(steps[cur].id);
  if(!c)return;
  c.classList.add("highlight");
  setTimeout(()=>c.classList.remove("highlight"),800);
}

function inputNum(v){
  if(!soundOK){magic.play().catch(()=>{});soundOK=true;}
  const c=document.getElementById(steps[cur].id);
  if(v==="del")c.textContent="";
  else c.textContent=v;
}

function check(){
  const s=steps[cur];
  const c=document.getElementById(s.id);
  if(+c.textContent===s.a){
    magic.play();
    combo++;
    if(combo>=3)combo.textContent=`${combo} „Ç≥„É≥„ÉúÔºÅüî•`;
    cur++;
    if(cur>=steps.length)clearGame();
    else highlight();
  }else{
    combo=0; combo.textContent="";
    c.textContent="";
  }
}

function clearGame(){
  clearSound.play();
  totalGems+=level;
  localStorage.setItem("mathGems",totalGems);
  updateStats();
  gems.textContent="üíé".repeat(level);
  clearOverlay.style.display="flex";
  confetti();
}

function confetti(){
  for(let i=0;i<20;i++){
    const d=document.createElement("div");
    d.className="confetti";
    d.textContent="üéâ";
    d.style.left=Math.random()*100+"%";
    d.style.top="-20px";
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),1500);
  }
}

initGame();
</script>
</body>
</html>
