<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Á≠ÜÁÆóÈÅìÂ†¥ - Á¢∫ÂÆöÁâà</title>
    <style>
        :root { --bg: #f0f4f8; --text: #334155; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: sans-serif; background: var(--bg); 
            display: flex; justify-content: center; padding: 10px; margin: 0;
        }
        .container { 
            background: white; border-radius: 15px; padding: 15px; 
            width: 100%; max-width: 450px; border: 3px solid #334155; 
            position: relative; margin-top: 40px; text-align: center;
        }
        .piko-container { position: absolute; top: -50px; right: 10px; display: flex; align-items: center; }
        .piko-balloon { background: #334155; color: white; padding: 4px 8px; border-radius: 8px; font-size: 12px; margin-right: 5px; }
        .piko-body { font-size: 40px; }

        .menu-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #334155; z-index: 200; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .level-card { width: 80%; padding: 12px; margin: 5px; border: 1px solid white; border-radius: 8px; cursor: pointer; }

        .board { display: inline-grid; gap: 2px; background: white; padding: 10px; border: 2px solid #334155; margin-bottom: 10px; width: 100%; }
        .board.col5 { grid-template-columns: repeat(5, 1fr); }
        .board.col6 { grid-template-columns: repeat(6, 1fr); }
        .cell { aspect-ratio: 1/1; display: flex; justify-content: center; align-items: center; font-size: 28px; font-weight: bold; position: relative; }
        .cell.input { background: #f1f5f9; border: 1px solid #94a3b8; border-radius: 4px; }
        .cell.active { border: 3px solid #ef4444 !important; background: #fff; }
        .cell.highlight { background: #fef08a !important; }
        .line { height: 2px; background: #333; margin: 2px 0; }
        .memo-canvas { position: absolute; top: -12px; left: 0; width: 24px; height: 24px; background: rgba(255,255,255,0.8); border: 1px solid #94a3b8; border-radius: 3px; z-index: 10; cursor: crosshair; }

        .keyboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .key { padding: 15px 0; font-size: 20px; font-weight: bold; border: 1px solid #cbd5e1; border-radius: 8px; background: white; box-shadow: 0 2px 0 #cbd5e1; }
        .key:active { transform: translateY(2px); box-shadow: none; }
        .key.ok { background: #334155; color: white; grid-column: span 2; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 100; border-radius: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="piko-container"><div class="piko-balloon" id="pikoTalk">„ÅÑ„Åè„ÇàÔºÅ</div><div class="piko-body">ü¶â</div></div>
    
    <div id="levelMenu" class="menu-overlay">
        <h2>Á≠ÜÁÆóÈÅìÂ†¥</h2>
        <div class="level-card" onclick="startLevel(1)">LV1: 2√ó2 (1-4)</div>
        <div class="level-card" onclick="startLevel(2)">LV2: 2√ó2 (1-9)</div>
        <div class="level-card" onclick="startLevel(3)">LV3: 2√ó2 (0„ÅÇ„Çä)</div>
        <div class="level-card" onclick="startLevel(4)">LV4: 3√ó2</div>
    </div>

    <div id="stats" style="margin-bottom:5px; font-size:14px;">üíé <span id="totalGemsCount">0</span></div>
    <div class="board" id="board"></div>

    <div class="keyboard">
        <button class="key" onclick="numInput(1)">1</button><button class="key" onclick="numInput(2)">2</button><button class="key" onclick="numInput(3)">3</button>
        <button class="key" onclick="numInput(4)">4</button><button class="key" onclick="numInput(5)">5</button><button class="key" onclick="numInput(6)">6</button>
        <button class="key" onclick="numInput(7)">7</button><button class="key" onclick="numInput(8)">8</button><button class="key" onclick="numInput(9)">9</button>
        <button class="key" onclick="numInput('del')">Ê∂à</button><button class="key" onclick="numInput(0)">0</button><button class="key" onclick="showHint()">ÁÅØ</button>
        <button class="key ok" onclick="check()">OK</button>
    </div>

    <button onclick="backToMenu()" style="margin-top:10px; background:none; border:none; color:#64748b; text-decoration:underline;">„É¨„Éô„É´ÈÅ∏Êäû„Å´Êàª„Çã</button>

    <div class="overlay" id="clearOverlay">
        <h2>CLEAR!</h2>
        <button class="key ok" style="width:120px" onclick="initGame()">Ê¨°„Å∏</button>
    </div>
</div>

<script>
    let n1, n2, steps=[], cur=0, currentLevel=1, totalGems=parseInt(localStorage.getItem('mathGems'))||0;

    function startLevel(lv) { currentLevel=lv; document.getElementById('levelMenu').style.display='none'; initGame(); }
    function backToMenu() { document.getElementById('levelMenu').style.display='flex'; }

    function initGame() {
        document.getElementById('clearOverlay').style.display='none';
        const b = document.getElementById('board');
        b.innerHTML = "";
        if(currentLevel===4) { b.className="board col6"; setup3x2(); } else { b.className="board col5"; setup2x2(); }
        render(); cur=0; checkAutoSkip(); update();
    }

    function setup2x2() {
        let min=(currentLevel===1)?1:0; let max=(currentLevel===1)?4:9;
        const gen=()=>Math.floor(Math.random()*(max-min+1))+min;
        n1=(gen()||1)*10+gen(); n2=(gen()||1)*10+gen();
        const d10=Math.floor(n2/10), d1=n2%10, p1=n1*d1, p2=n1*d10, total=n1*n2;
        steps = [
            {id:'p1_1', ans:p1%10, h:[3,8]}, {id:'p1_10', ans:Math.floor(p1/10)%10, h:[2,8]}, {id:'p1_100', ans:Math.floor(p1/100)||0, h:[2,8]},
            {id:'p2_10', ans:p2%10, h:[3,7]}, {id:'p2_100', ans:Math.floor(p2/10)%10, h:[2,7]}, {id:'p2_1000', ans:Math.floor(p2/100)||0, h:[2,7]},
            {id:'a1', ans:total%10, h:[13,18]}, {id:'a10', ans:Math.floor(total/10)%10, h:[12,17]}, {id:'a100', ans:Math.floor(total/100)%10, h:[11,16]}, {id:'a1000', ans:Math.floor(total/1000)||0, h:[10,15]}
        ];
    }

    function setup3x2() {
        n1=Math.floor(Math.random()*900)+100; n2=Math.floor(Math.random()*90)+10;
        const d10=Math.floor(n2/10), d1=n2%10, p1=n1*d1, p2=n1*d10, total=n1*n2;
        steps = [
            {id:'p1_1', ans:p1%10, h:[4,10]}, {id:'p1_10', ans:Math.floor(p1/10)%10, h:[3,10]}, {id:'p1_100', ans:Math.floor(p1/100)%10, h:[2,10]}, {id:'p1_1000', ans:Math.floor(p1/1000)||0, h:[2,10]},
            {id:'p2_10', ans:p2%10, h:[4,9]}, {id:'p2_100', ans:Math.floor(p2/10)%10, h:[3,9]}, {id:'p2_1000', ans:Math.floor(p2/100)%10, h:[2,9]}, {id:'p2_10000', ans:Math.floor(p2/1000)||0, h:[2,9]},
            {id:'a1', ans:total%10, h:[16,22]}, {id:'a10', ans:Math.floor(total/10)%10, h:[15,21]}, {id:'a100', ans:Math.floor(total/100)%10, h:[14,20]}, {id:'a1000', ans:Math.floor(total/1000)%10, h:[13,19]}, {id:'a10000', ans:Math.floor(total/10000)||0, h:[12,18]}
        ];
    }

    function render() {
        const b=document.getElementById('board'); let html="";
        if(currentLevel===4) {
            const s1=String(n1).padStart(3,' '), s2=String(n2).padStart(2,' ');
            html = `<div class="cell"></div><div class="cell"></div><div class="cell">${s1[0]}</div><div class="cell">${s1[1]}</div><div class="cell">${s1[2]}</div><div class="cell"></div>` +
                   `<div class="cell"></div><div class="cell">√ó</div><div class="cell"></div><div class="cell">${s2[0]}</div><div class="cell">${s2[1]}</div><div class="cell"></div>` +
                   `<div class="line" style="grid-column:1/7"></div>` +
                   `<div class="cell"></div><div id="p1_1000" class="cell input"></div><div id="p1_100" class="cell input"></div><div id="p1_10" class="cell input"></div><div id="p1_1" class="cell input"></div><div class="cell"></div>` +
                   `<div id="p2_10000" class="cell input"></div><div id="p2_1000" class="cell input"></div><div id="p2_100" class="cell input"></div><div id="p2_10" class="cell input"></div><div class="cell" style="color:#ccc">0</div><div class="cell"></div>` +
                   `<div class="line" style="grid-column:1/7"></div>` +
                   `<div id="a10000" class="cell input"></div><div id="a1000" class="cell input"></div><div id="a100" class="cell input"></div><div id="a10" class="cell input"></div><div id="a1" class="cell input"></div><div class="cell"></div>`;
        } else {
            const s1=String(n1).padStart(2,' '), s2=String(n2).padStart(2,' ');
            html = `<div class="cell"></div><div class="cell"></div><div class="cell">${s1[0]}</div><div class="cell">${s1[1]}</div><div class="cell"></div>` +
                   `<div class="cell">√ó</div><div class="cell"></div><div class="cell">${s2[0]}</div><div class="cell">${s2[1]}</div><div class="cell"></div>` +
                   `<div class="line" style="grid-column:1/6"></div>` +
                   `<div class="cell"></div><div id="p1_100" class="cell input"></div><div id="p1_10" class="cell input"></div><div id="p1_1" class="cell input"></div><div class="cell"></div>` +
                   `<div id="p2_1000" class="cell input"></div><div id="p2_100" class="cell input"></div><div id="p2_10" class="cell input"></div><div class="cell" style="color:#ccc">0</div><div class="cell"></div>` +
                   `<div class="line" style="grid-column:1/6"></div>` +
                   `<div id="a1000" class="cell input"></div><div id="a100" class="cell input"></div><div id="a10" class="cell input"></div><div id="a1" class="cell input"></div><div class="cell"></div>`;
        }
        b.innerHTML=html;
        document.querySelectorAll('.cell.input').forEach(el=>{
            const s=document.createElement('span'); el.appendChild(s);
            const c=document.createElement('canvas'); c.className='memo-canvas'; c.width=40; c.height=40; el.appendChild(c);
            initDraw(c, el);
        });
    }

    function initDraw(c, p) {
        const ctx=c.getContext('2d'); ctx.strokeStyle='#ef4444'; ctx.lineWidth=4; ctx.lineCap='round';
        let d=false;
        const getP=(e)=>{
            const r=c.getBoundingClientRect(); const cx=e.touches?e.touches[0].clientX:e.clientX; const cy=e.touches?e.touches[0].clientY:e.clientY;
            return {x:(cx-r.left)*(c.width/r.width), y:(cy-r.top)*(c.height/r.height)};
        };
        const s=(e)=>{ if(p.id===steps[cur].id) update(); d=true; ctx.beginPath(); ctx.moveTo(getP(e).x, getP(e).y); };
        const m=(e)=>{ if(!d)return; e.preventDefault(); const pos=getP(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); };
        c.addEventListener('mousedown',s); c.addEventListener('mousemove',m); window.addEventListener('mouseup',()=>d=false);
        c.addEventListener('touchstart',s,{passive:false}); c.addEventListener('touchmove',m,{passive:false}); c.addEventListener('touchend',()=>d=false);
    }

    function numInput(v) {
        const active=document.getElementById(steps[cur].id); if(!active)return;
        const s=active.querySelector('span'); s.textContent=(v==='del')?"":v;
    }

    function check() {
        const s=steps[cur]; const active=document.getElementById(s.id); if(!active)return;
        if(parseInt(active.querySelector('span').textContent)===s.ans) {
            active.classList.remove('active'); active.style.background="#dcfce7";
            cur++; checkAutoSkip();
            if(cur>=steps.length) { document.getElementById('clearOverlay').style.display='flex'; totalGems+=10; localStorage.setItem('mathGems',totalGems); updateStats(); }
            else update();
        } else { active.querySelector('span').textContent=""; }
    }

    function checkAutoSkip() {
        while(cur < steps.length) {
            const s = steps[cur];
            // ÂÖàÈ†≠„ÅÆ0Âà§ÂÆöÔºàÂêÑË°å„ÅÆÊúÄ„ÇÇÂ∑¶ÂÅ¥„ÅÆ„Éû„Çπ„Åß„ÄÅÁ≠î„Åà„Åå0„ÅÆÂ†¥ÂêàÔºâ
            const isLeadingZero = (s.ans === 0 && (s.id.includes('1000') || s.id.includes('10000')));
            if(isLeadingZero) {
                const cell = document.getElementById(s.id);
                if(cell) { cell.classList.remove('input','active'); cell.style.background="transparent"; }
                cur++;
            } else break;
        }
    }

    function update() {
        document.querySelectorAll('.cell').forEach(c=>c.classList.remove('active','highlight'));
        const s=steps[cur]; if(!s)return;
        const active=document.getElementById(s.id); if(active) active.classList.add('active');
        s.h.forEach(idx=>{ const t=document.querySelectorAll('.cell')[idx]; if(t) t.classList.add('highlight'); });
    }

    function showHint() { steps[cur].h.forEach(idx=>{ const t=document.querySelectorAll('.cell')[idx]; if(t) t.animate([{background:'#fef08a'},{background:'#facc15'},{background:'#fef08a'}],500); }); }
    function updateStats() { document.getElementById('totalGemsCount').textContent=totalGems; }
    function backToMenu() { document.getElementById('levelMenu').style.display='flex'; }
    updateStats();
</script>
</body>
</html>
